{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div>
        <h1>GESTIÓN INDIVIDUAL</h1>
        <p style="color: var(--text-dim); margin-top: 10px;">
            <a href="/equipo/{{ equipo_grupo.id }}" style="color: var(--orange); text-decoration: none;">
                ← {{ equipo_grupo.nombre }}
            </a>
        </p>
    </div>
</div>

<!-- Estadísticas -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card" style="background: rgba(0, 255, 136, 0.1); border-left: 4px solid var(--green);">
        <h3 style="color: var(--green); margin: 0;">{{ stats.disponibles }}</h3>
        <p style="margin: 5px 0 0 0; color: var(--text-dim);">Disponibles</p>
    </div>
    <div class="card" style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid var(--orange);">
        <h3 style="color: var(--orange); margin: 0;">{{ stats.en_uso }}</h3>
        <p style="margin: 5px 0 0 0; color: var(--text-dim);">En Uso</p>
    </div>
    <div class="card" style="background: rgba(255, 68, 68, 0.1); border-left: 4px solid var(--red);">
        <h3 style="color: var(--red); margin: 0;">{{ stats.danados }}</h3>
        <p style="margin: 5px 0 0 0; color: var(--text-dim);">Dañados</p>
    </div>
    <div class="card" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid var(--text-dim);">
        <h3 style="color: var(--text-main); margin: 0;">{{ stats.total }}</h3>
        <p style="margin: 5px 0 0 0; color: var(--text-dim);">Total</p>
    </div>
</div>

<!-- Filtros -->
<div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
    <a href="?filtro=todos" class="btn-outline {{ 'active' if filtro == 'todos' }}"
        style="{{ 'background: var(--orange); color: #000;' if filtro == 'todos' }}">
        TODOS
    </a>
    <a href="?filtro=disponibles" class="btn-outline {{ 'active' if filtro == 'disponibles' }}"
        style="{{ 'background: var(--green); color: #000;' if filtro == 'disponibles' }}">
        DISPONIBLES
    </a>
    <a href="?filtro=en_uso" class="btn-outline {{ 'active' if filtro == 'en_uso' }}"
        style="{{ 'background: var(--orange); color: #000;' if filtro == 'en_uso' }}">
        EN USO
    </a>
    <a href="?filtro=danados" class="btn-outline {{ 'active' if filtro == 'danados' }}"
        style="{{ 'background: var(--red); color: #000;' if filtro == 'danados' }}">
        DAÑADOS
    </a>
</div>

<!-- Tabla de Equipos Individuales -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>FIXTURE #</th>
                <th>NÚMERO DE SERIE</th>
                <th>ESTADO</th>
                <th>MOVIMIENTO</th>
                <th>OBSERVACIONES</th>
                <th style="text-align: right;">ACCIONES</th>
            </tr>
        </thead>
        <tbody>
            {% for eq in equipos_ind %}
            <tr style="{{ 'background: rgba(255, 0, 0, 0.1);' if eq.danado }}">
                <td data-label="Fixture #">
                    <span style="font-family: 'JetBrains Mono'; font-weight: 700; font-size: 1.1rem;">
                        #{{ eq.numero_fixture }}
                    </span>
                </td>
                <td data-label="Serie">
                    <span style="font-family: 'JetBrains Mono'; color: var(--text-dim);">
                        {{ eq.numero_serie }}
                    </span>
                </td>
                <td data-label="Estado">
                    {% if eq.danado %}
                    <span style="color: var(--red); font-weight: 700;">⚠️ DAÑADO</span>
                    {% elif eq.en_uso %}
                    <span style="color: var(--orange); font-weight: 600;">EN USO</span>
                    {% else %}
                    <span style="color: var(--green); font-weight: 600;">✓ DISPONIBLE</span>
                    {% endif %}
                </td>
                <td data-label="Movimiento">
                    <form method="POST" style="display:flex; flex-direction: column; gap:10px; min-width: 220px;">
                        <input type="hidden" name="cant_lote" value="1">
                        <input type="hidden" name="ind_id" value="{{ eq.id }}">

                        <div style="display:flex; flex-direction: column; gap:5px;">
                            <input type="text" name="donde" list="list-ubicaciones" placeholder="¿Dónde?"
                                value="{{ eq.ubicacion_actual if eq.en_uso else '' }}"
                                style="width: 100%; height: 38px; font-size:0.8rem;" required>

                        </div>

                        <div style="display:flex; flex-direction: column; gap:10px;">
                            <button type="submit" formaction="/movimiento/{{ equipo_grupo.id }}/prestar"
                                class="btn-main" {{ 'disabled' if eq.en_uso or eq.danado }}
                                style="padding: 10px; font-size: 0.75rem; {{ 'filter:grayscale(1); opacity:0.5;' if eq.en_uso or eq.danado }}">
                                REGISTRAR SALIDA
                            </button>

                            <div style="display:grid; grid-template-columns: 1fr 80px; gap: 8px;">
                                <button type="submit" formaction="/movimiento/{{ equipo_grupo.id }}/devolver"
                                    class="btn-main" style="background:var(--green); padding: 10px; font-size: 0.75rem;"
                                    {{ 'disabled' if not eq.en_uso }}>
                                    REGISTRAR RETORNO
                                </button>
                                <select name="estado_retorno"
                                    style="padding: 2px; font-size: 0.7rem; height: 38px; border-radius: 4px;">
                                    <option value="Buen Estado">OK</option>
                                    <option value="Dañado">⚠️ DAÑADO</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </td>
                <td data-label="Observaciones">
                    <form method="POST" action="/equipo/{{ equipo_grupo.id }}/individual/{{ eq.id }}/update"
                        style="display: flex; gap: 8px;">
                        <input type="text" name="observaciones" value="{{ eq.observaciones_individuales }}"
                            placeholder="Agregar observación..." style="flex: 1; font-size: 0.85rem;">
                        <button type="submit" class="btn-outline" style="padding: 6px 12px; font-size: 0.75rem;">
                            GUARDAR
                        </button>
                    </form>
                </td>
                <td style="text-align: right;">
                    <div class="actions-list">
                        <form method="POST" action="/equipo/{{ equipo_grupo.id }}/individual/{{ eq.id }}/toggle_danado"
                            style="display: inline;">
                            <button type="submit" class="btn-outline"
                                style="background: {{ 'var(--green)' if eq.danado else 'var(--red)' }}; color: #000; padding: 8px 12px; font-size: 0.75rem;">
                                {{ 'REPARAR' if eq.danado else 'MARCAR DAÑADO' }}
                            </button>
                        </form>

                        <form method="POST" action="/equipo/{{ equipo_grupo.id }}/individual/{{ eq.id }}/delete"
                            style="display: inline;"
                            onsubmit="return confirm('¿Eliminar equipo #{{ eq.numero_fixture }}?');">
                            <button type="submit" class="btn-delete">×</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}

            {% if equipos_ind|length == 0 %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-dim);">
                    No hay equipos que coincidan con el filtro seleccionado.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Formulario para Agregar Equipo Individual -->
<div class="card" style="margin-top: 40px; border-top: 4px solid var(--orange);">
    <h3>AGREGAR EQUIPO INDIVIDUAL</h3>
    <form method="POST" action="/equipo/{{ equipo_grupo.id }}/individual/add"
        style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: end;">
        <div>
            <label style="display: block; margin-bottom: 8px; color: var(--text-dim); font-size: 0.85rem;">
                FIXTURE #
            </label>
            <input type="number" name="numero_fixture" required style="width: 100%;" placeholder="1">
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; color: var(--text-dim); font-size: 0.85rem;">
                NÚMERO DE SERIE
            </label>
            <input type="text" name="numero_serie" required style="width: 100%;" placeholder="Ej: 706003122900194">
        </div>
        <button type="submit" class="btn-main" style="padding: 12px 24px;">
            AGREGAR
        </button>
    </form>
</div>

{% endblock %}